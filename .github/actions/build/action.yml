name: Build Docker Image
inputs:
  app:
    description: The app to build
    required: true
    default: "nextjs"

description: Build Docker Image
runs:
  using: "composite"
  steps:
    - name: Create folder for Docker Image Artifact/s
      run: |
        mkdir docker-image-artifacts
        echo "Created folder for Docker Image Artifact/s"
      shell: bash

    - name: Build ${{inputs.app}} Docker Image
      if: ${{ inputs.app == 'api' || inputs.app == 'all' }}
      run: |
        docker build -t cheapbmorehousesregistry.azurecr.io/api:latest . -f Dockerfile.api
        docker save cheapbmorehousesregistry.azurecr.io/api:latest -o docker-image-artifacts/api-latest.tar
        echo "Built and saved api Docker image"
      shell: bash

    - name: Build ${{inputs.app}} Docker Image
      if: ${{ inputs.app == 'nginx' || inputs.app == 'all' }}
      run: |
        cd nginx
        docker build -t cheapbmorehousesregistry.azurecr.io/nginx:latest . -f Dockerfile
        cd ..
        docker save cheapbmorehousesregistry.azurecr.io/nginx:latest -o docker-image-artifacts/nginx-latest.tar
        echo "Built and saved nginx Docker image"
      shell: bash

    - name: Build ${{inputs.app}} Docker Image
      if: ${{ inputs.app == 'nextjs' || inputs.app == 'all' }}
      run: |
        docker build -t cheapbmorehousesregistry.azurecr.io/nextjs:latest . -f Dockerfile
        docker save cheapbmorehousesregistry.azurecr.io/nextjs:latest -o docker-image-artifacts/nextjs-latest.tar
        echo "Built and saved nextjs Docker image"
      shell: bash

    - name: Upload ${{inputs.app}} Docker Image Artifact/s
      uses: actions/upload-artifact@v3
      with:
        name: docker-image-artifacts
        path: docker-image-artifacts
      if: always()
